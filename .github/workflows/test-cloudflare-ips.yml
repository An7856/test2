name: Cloudflareä»£ç†IPè‡ªåŠ¨åŒ–æµ‹è¯•

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤©UTCæ—¶é—´0ç‚¹è‡ªåŠ¨è¿è¡Œ

jobs:
  cf-ip-tester:
    runs-on: ubuntu-latest
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install requests numpy ipaddress

    - name: åˆ›å»ºè¾“å‡ºç›®å½•
      run: mkdir -p ./test_results

    - name: è¿è¡ŒIPæµ‹è¯•å¹¶ç”ŸæˆæŠ¥å‘Š
      run: |
        cat << 'EOF' > cf_ip_tester.py
        import requests
        import time
        import random
        import ipaddress
        import json
        from datetime import datetime
        from concurrent.futures import ThreadPoolExecutor, as_completed

        # é…ç½®å‚æ•°
        CLOUDFLARE_IP_RANGES = [
            "173.245.48.0/20", "103.21.244.0/22", "103.22.200.0/22",
            "103.31.4.0/22", "141.101.64.0/18", "108.162.192.0/18"
        ]
        TEST_IPS_PER_RANGE = 3  # æ¯ä¸ªèŒƒå›´æµ‹è¯•3ä¸ªIP
        MAX_WORKERS = 10        # å¹¶å‘çº¿ç¨‹æ•°
        TIMEOUT = 5             # è¶…æ—¶æ—¶é—´(ç§’)

        def generate_test_ips():
            """ä»CloudflareèŒƒå›´ç”Ÿæˆéšæœºæµ‹è¯•IP"""
            test_ips = []
            for ip_range in CLOUDFLARE_IP_RANGES:
                network = ipaddress.ip_network(ip_range)
                for _ in range(TEST_IPS_PER_RANGE):
                    network_int = int.from_bytes(network.network_address.packed, "big")
                    rand_ip = network_int + random.getrandbits(32 - network.prefixlen)
                    test_ips.append(str(ipaddress.IPv4Address(rand_ip)))
            return test_ips

        def test_ip(ip):
            """æµ‹è¯•å•ä¸ªIPçš„å»¶è¿Ÿå’Œå¯ç”¨æ€§"""
            try:
                start = time.time()
                r = requests.get(
                    f"http://{ip}",
                    headers={"Host": "www.cloudflare.com"},
                    timeout=TIMEOUT,
                    allow_redirects=False
                )
                latency = (time.time() - start) * 1000  # æ¯«ç§’
                return {
                    "ip": ip,
                    "latency": round(latency, 2),
                    "status": "OK" if r.status_code in [301, 302, 307, 308] else "Fail",
                    "tested_at": datetime.now().isoformat()
                }
            except Exception as e:
                return {
                    "ip": ip,
                    "latency": 9999,
                    "status": f"Error: {str(e)}",
                    "tested_at": datetime.now().isoformat()
                }

        def generate_report(results):
            """ç”ŸæˆTXTæ ¼å¼æµ‹è¯•æŠ¥å‘Š"""
            report = [
                "="*70,
                f"Cloudflareä»£ç†IPæµ‹è¯•æŠ¥å‘Š".center(60),
                f"ç”Ÿæˆæ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}",
                "="*70,
                "åºå·   IPåœ°å€          å»¶è¿Ÿ(ms)  çŠ¶æ€",
                "-"*70
            ]
            
            # æŒ‰å»¶è¿Ÿæ’åºå¹¶è¿‡æ»¤æˆåŠŸç»“æœ
            working_ips = [r for r in results if r['status'] == 'OK']
            sorted_ips = sorted(working_ips, key=lambda x: x['latency'])
            
            for idx, result in enumerate(sorted_ips[:20], 1):  # åªæ˜¾ç¤ºå‰20ä¸ª
                report.append(
                    f"{idx:<6} {result['ip']:<15} {result['latency']:>8.2f}   {result['status']}"
                )
            
            report.extend([
                "-"*70,
                f"æ€»æµ‹è¯•IP: {len(results)} ä¸ª",
                f"æœ‰æ•ˆIP: {len(working_ips)} ä¸ª",
                f"å¹³å‡å»¶è¿Ÿ: {sum(r['latency'] for r in working_ips)/len(working_ips):.2f} ms" if working_ips else "æ— æœ‰æ•ˆIP",
                "="*70
            ])
            return "\n".join(report)

        def save_results(data, report):
            """ä¿å­˜æµ‹è¯•ç»“æœ"""
            os.makedirs("./test_results", exist_ok=True)
            
            # ä¿å­˜TXTæŠ¥å‘Š
            with open("./test_results/cf_ip_report.txt", "w", encoding="utf-8") as f:
                f.write(report)
            
            # ä¿å­˜åŸå§‹JSONæ•°æ®
            with open("./test_results/cf_ip_data.json", "w", encoding="utf-8") as f:
                json.dump({
                    "metadata": {
                        "generated_at": datetime.now().isoformat(),
                        "total_tested": len(data)
                    },
                    "results": data
                }, f, indent=2, ensure_ascii=False)

        def main():
            print("ğŸŸ¢ å¼€å§‹Cloudflareä»£ç†IPæµ‹è¯•")
            test_ips = generate_test_ips()
            print(f"ğŸ” å…±ç”Ÿæˆ {len(test_ips)} ä¸ªæµ‹è¯•IP")

            print("âš¡ å¼€å§‹å¹¶å‘æµ‹è¯•...")
            results = []
            with ThreadPoolExecutor(max_workers=MAX_WORKERS) as executor:
                futures = {executor.submit(test_ip, ip): ip for ip in test_ips}
                for future in as_completed(futures):
                    results.append(future.result())
                    print(f"æµ‹è¯•å®Œæˆ: {future.result()['ip']} ({future.result()['status']})")

            print("ğŸ“Š ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š...")
            report = generate_report(results)
            save_results(results, report)
            
            print("\nğŸ”· æµ‹è¯•æŠ¥å‘Šé¢„è§ˆ:")
            print(report[:300] + "...\n")
            print("âœ… æµ‹è¯•å®Œæˆï¼ç»“æœå·²ä¿å­˜åˆ° ./test_results/ ç›®å½•")

        if __name__ == "__main__":
            import os
            main()
        EOF

        python cf_ip_tester.py

    - name: éªŒè¯ç”Ÿæˆæ–‡ä»¶
      run: |
        echo "ğŸ“‚ ç›®å½•ç»“æ„:"
        ls -lh ./test_results/
        echo "\nğŸ“ æŠ¥å‘Šé¢„è§ˆ:"
        head -n 15 ./test_results/cf_ip_report.txt
        echo "\nğŸ“Š JSONæ•°æ®ç»Ÿè®¡:"
        jq '.metadata + {working_ips: (.results | map(select(.status=="OK") | length)}' ./test_results/cf_ip_data.json

    - name: ä¸Šä¼ æµ‹è¯•ç»“æœ
      uses: actions/upload-artifact@v4
      with:
        name: cloudflare-ip-test-results
        path: |
          ./test_results/cf_ip_report.txt
          ./test_results/cf_ip_data.json
        if-no-files-found: error
        retention-days: 7
      timeout-minutes: 5
